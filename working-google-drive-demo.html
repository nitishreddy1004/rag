<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working Google Drive Zoning Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        'primary-light': '#3b82f6',
                        'primary-dark': '#1d4ed8'
                    }
                }
            }
        }
    </script>
    <style>
        .icon-search::before { content: "üîç"; }
        .icon-document::before { content: "üìÑ"; }
        .icon-ai::before { content: "ü§ñ"; }
        .icon-drive::before { content: "‚òÅÔ∏è"; }
        .icon-rag::before { content: "üß†"; }
        .icon-check::before { content: "‚úÖ"; }
        .icon-loading::before { content: "‚è≥"; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="icon-ai text-3xl mr-3"></div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Working Google Drive Zoning Assistant</h1>
                        <p class="text-sm text-gray-600">Real Google Drive Integration + RAG</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <span class="icon-drive mr-1"></span>
                        <span id="document-count">Initializing...</span>
                    </div>
                    <div class="text-sm text-gray-500">
                        <span class="icon-rag mr-1"></span>
                        <span id="rag-status">Initializing...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Query Interface -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">
                        <span class="icon-ai mr-2"></span>
                        Ask Your Zoning Question
                    </h2>
                    
                    <!-- City Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Select City/Jurisdiction
                        </label>
                        <select id="city-selector" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="kansas_city">Kansas City, MO</option>
                            <option value="dallas">Dallas, TX</option>
                            <option value="new_york">New York City, NY</option>
                            <option value="los_angeles">Los Angeles, CA</option>
                            <option value="chicago">Chicago, IL</option>
                            <option value="hempstead">Town of Hempstead</option>
                            <option value="brookhaven">Town of Brookhaven</option>
                            <option value="oyster_bay">Town of Oyster Bay</option>
                        </select>
                    </div>

                    <!-- Query Input -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Your Question
                        </label>
                        <textarea 
                            id="query-input" 
                            rows="4" 
                            placeholder="e.g., What is the zoning code for Kansas City? What are the setback requirements for residential zones?"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                        ></textarea>
                    </div>

                    <!-- Submit Button -->
                    <button 
                        id="submit-btn" 
                        class="w-full bg-primary text-white py-3 px-6 rounded-lg hover:bg-primary-light transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span class="icon-search mr-2"></span>
                        Search Google Drive + External Sources
                    </button>

                    <!-- Sample Questions -->
                    <div class="mt-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Try these sample questions:</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <button class="sample-question text-left text-sm text-primary hover:text-primary-light hover:bg-blue-50 p-2 rounded border border-gray-200">
                                "What is the zoning code for Kansas City?"
                            </button>
                            <button class="sample-question text-left text-sm text-primary hover:text-primary-light hover:bg-blue-50 p-2 rounded border border-gray-200">
                                "What are the setback requirements for R1 zone?"
                            </button>
                            <button class="sample-question text-left text-sm text-primary hover:text-primary-light hover:bg-blue-50 p-2 rounded border border-gray-200">
                                "Can I build a medical office in commercial zones?"
                            </button>
                            <button class="sample-question text-left text-sm text-primary hover:text-primary-light hover:bg-blue-50 p-2 rounded border border-gray-200">
                                "What are the building codes for Dallas, Texas?"
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Response Display -->
                <div id="response-container" class="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <span class="icon-ai mr-2"></span>
                        AI Response
                    </h3>
                    <div id="response-content" class="space-y-4">
                        <!-- Response will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Info -->
            <div class="space-y-6">
                <!-- Document Statistics -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <span class="icon-document mr-2"></span>
                        Document Statistics
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Total Documents:</span>
                            <span id="total-docs" class="font-medium">Loading...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Cities Covered:</span>
                            <span id="cities-covered" class="font-medium">Loading...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Status:</span>
                            <span id="status" class="font-medium text-yellow-600">Initializing...</span>
                        </div>
                    </div>
                </div>

                <!-- Service Status -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <span class="icon-check mr-2"></span>
                        Service Status
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Google Drive:</span>
                            <span id="drive-status" class="flex items-center">
                                <span class="icon-loading text-yellow-500 mr-1"></span>
                                <span class="text-sm text-yellow-600">Connecting...</span>
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">RAG Service:</span>
                            <span id="rag-service-status" class="flex items-center">
                                <span class="icon-loading text-yellow-500 mr-1"></span>
                                <span class="text-sm text-yellow-600">Initializing...</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Recent Searches -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <span class="icon-search mr-2"></span>
                        Recent Searches
                    </div>
                    <div id="recent-searches" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-sm text-gray-500 text-center py-4">
                            No searches yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script>
        // Global variables
        let searchHistory = [];
        let isProcessing = false;
        let googleDriveService = null;
        let ragService = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Working Google Drive Zoning Assistant initializing...');
            initializeServices();
            setupEventListeners();
        });

        async function initializeServices() {
            try {
                // Initialize Google Drive Service
                googleDriveService = new GoogleDriveService();
                await googleDriveService.initialize();
                
                // Initialize RAG Service
                ragService = new ZoningRAGService();
                await ragService.initialize();
                
                // Update UI
                updateStatusDisplays();
                updateDocumentStats();
                
                console.log('‚úÖ All services initialized successfully');
            } catch (error) {
                console.error('‚ùå Service initialization failed:', error);
                showError('Failed to initialize services. Please refresh the page.');
            }
        }

        function setupEventListeners() {
            // Submit button
            document.getElementById('submit-btn').addEventListener('click', handleQuerySubmit);
            
            // Sample questions
            document.querySelectorAll('.sample-question').forEach(btn => {
                btn.addEventListener('click', () => {
                    const question = btn.textContent.replace(/"/g, '');
                    document.getElementById('query-input').value = question;
                    
                    // Auto-detect city from question
                    if (question.toLowerCase().includes('kansas city')) {
                        document.getElementById('city-selector').value = 'kansas_city';
                    } else if (question.toLowerCase().includes('dallas')) {
                        document.getElementById('city-selector').value = 'dallas';
                    } else if (question.toLowerCase().includes('new york')) {
                        document.getElementById('city-selector').value = 'new_york';
                    }
                });
            });

            // Enter key in textarea
            document.getElementById('query-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleQuerySubmit();
                }
            });
        }

        async function handleQuerySubmit() {
            const query = document.getElementById('query-input').value.trim();
            const city = document.getElementById('city-selector').value;
            
            if (!query) {
                showError('Please enter a question');
                return;
            }

            if (isProcessing) return;
            isProcessing = true;

            // Update UI state
            setLoadingState(true);
            clearResponse();

            try {
                console.log(`üîç Processing query: "${query}" for city: ${city}`);
                
                // Use Google Drive Service to get documents
                const townDocuments = await googleDriveService.loadTownSpecificDocuments(city);
                console.log(`üìö Found ${townDocuments.length} documents for ${city}`);
                
                // Use RAG Service to get comprehensive response
                const result = await ragService.queryWithRAG(query, townDocuments, city);
                console.log(`ü§ñ Generated response with confidence: ${result.confidence}`);
                
                // Display results
                displayResponse(result, townDocuments);
                
                // Update search history
                addToSearchHistory(query, result, townDocuments.length);
                
            } catch (error) {
                console.error('Query processing failed:', error);
                showError('Failed to process your question. Please try again.');
            } finally {
                setLoadingState(false);
                isProcessing = false;
            }
        }

        function displayResponse(result, townDocuments) {
            const container = document.getElementById('response-container');
            const content = document.getElementById('response-content');
            
            // Clear previous content
            content.innerHTML = '';
            
            // Add answer
            const answerDiv = document.createElement('div');
            answerDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4';
            answerDiv.innerHTML = `
                <h4 class="font-medium text-blue-900 mb-2">Answer:</h4>
                <p class="text-blue-800">${result.answer}</p>
            `;
            content.appendChild(answerDiv);
            
            // Add source information
            if (result.sources && result.sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4';
                
                let sourcesHtml = '<h4 class="font-medium text-gray-900 mb-2">Sources:</h4><div class="space-y-2">';
                
                if (townDocuments.length > 0) {
                    sourcesHtml += `<div class="text-sm text-gray-600">üìö Found in ${townDocuments.length} Google Drive document(s)</div>`;
                }
                
                const externalSources = result.sources.filter(s => s.type === 'external').length;
                if (externalSources > 0) {
                    sourcesHtml += `<div class="text-sm text-gray-600">üåê Enhanced with ${externalSources} external source(s)</div>`;
                }
                
                sourcesHtml += '<div class="mt-2"><h5 class="text-xs font-medium text-gray-600 mb-1">Document Sources:</h5><ul class="space-y-1">';
                result.sources.forEach(source => {
                    sourcesHtml += `<li class="text-xs text-gray-600">‚Ä¢ ${source.name} (${source.type})</li>`;
                });
                sourcesHtml += '</ul></div></div>';
                
                sourcesDiv.innerHTML = sourcesHtml;
                content.appendChild(sourcesDiv);
            }
            
            // Add confidence score
            const confidenceDiv = document.createElement('div');
            confidenceDiv.className = 'bg-green-50 border border-green-200 rounded-lg p-4';
            confidenceDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-green-900">Confidence Score:</span>
                    <span class="text-lg font-bold text-green-700">${Math.round((result.confidence || 0) * 100)}%</span>
                </div>
            `;
            content.appendChild(confidenceDiv);
            
            // Show container
            container.classList.remove('hidden');
        }

        function addToSearchHistory(query, result, documentCount) {
            const searchRecord = {
                query,
                timestamp: new Date(),
                city: document.getElementById('city-selector').value,
                resultCount: documentCount,
                externalSources: result.sources ? result.sources.filter(s => s.type === 'external').length : 0,
                confidence: result.confidence || 0
            };
            
            searchHistory.unshift(searchRecord);
            
            // Keep only last 10 searches
            if (searchHistory.length > 10) {
                searchHistory = searchHistory.slice(0, 10);
            }
            
            updateRecentSearches();
        }

        function updateRecentSearches() {
            const container = document.getElementById('recent-searches');
            
            if (searchHistory.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">No searches yet</div>';
                return;
            }
            
            container.innerHTML = searchHistory.map(search => `
                <div class="text-xs text-gray-600 p-2 bg-gray-50 border border-gray-200 rounded">
                    <div class="font-medium text-gray-800">${search.query}</div>
                    <div class="text-gray-500 mt-1">
                        ${search.timestamp.toLocaleTimeString()} ‚Ä¢ ${search.city} ‚Ä¢ 
                        ${search.resultCount} docs ‚Ä¢ ${search.externalSources} external
                    </div>
                    <div class="text-gray-400 mt-1">
                        Confidence: ${Math.round(search.confidence * 100)}%
                    </div>
                </div>
            `).join('');
        }

        function updateStatusDisplays() {
            // Update Google Drive status
            if (googleDriveService) {
                document.getElementById('drive-status').innerHTML = `
                    <span class="icon-check text-green-500 mr-1"></span>
                    <span class="text-sm text-green-600">Connected</span>
                `;
                document.getElementById('document-count').textContent = 'Ready';
            }
            
            // Update RAG status
            if (ragService) {
                document.getElementById('rag-status').textContent = 'Active';
                document.getElementById('rag-service-status').innerHTML = `
                    <span class="icon-check text-green-500 mr-1"></span>
                    <span class="text-sm text-green-600">Active</span>
                `;
            }
        }

        function updateDocumentStats() {
            if (googleDriveService) {
                const stats = googleDriveService.getDocumentStats();
                const totalDocs = Object.values(stats).reduce((sum, count) => sum + count, 0);
                const citiesCovered = Object.keys(stats).length;
                
                document.getElementById('total-docs').textContent = totalDocs;
                document.getElementById('cities-covered').textContent = citiesCovered;
                document.getElementById('status').textContent = 'Ready';
                document.getElementById('status').className = 'font-medium text-green-600';
            }
        }

        function setLoadingState(loading) {
            const submitBtn = document.getElementById('submit-btn');
            if (loading) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
                    <span class="icon-loading mr-2"></span>
                    Searching Google Drive...
                `;
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
                    <span class="icon-search mr-2"></span>
                    Search Google Drive + External Sources
                `;
            }
        }

        function clearResponse() {
            document.getElementById('response-container').classList.add('hidden');
        }

        function showError(message) {
            // Create error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">‚ùå</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(errorDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Google Drive Service Class (Embedded)
        class GoogleDriveService {
            constructor() {
                this.folderId = '1Jte-sydPmkicOZgC0zUJrkVsctnX_NBy';
                this.apiKey = 'AIzaSyB78lP81FiCsO7B29Iz1Fq9yIGuZ9RX4LE';
                this.baseUrl = 'https://www.googleapis.com/drive/v3';
                this.townDocumentMapping = {
                    'hempstead': ['hempstead', 'town of hempstead', 'hempstead zoning', 'hempstead code'],
                    'oyster_bay': ['oyster bay', 'town of oyster bay', 'oyster bay zoning', 'oyster bay code'],
                    'brookhaven': ['brookhaven', 'town of brookhaven', 'brookhaven zoning', 'brookhaven code'],
                    'huntington': ['huntington', 'town of huntington', 'huntington zoning', 'huntington code'],
                    'islip': ['islip', 'town of islip', 'islip zoning', 'islip code'],
                    'babylon': ['babylon', 'town of babylon', 'babylon zoning', 'babylon code'],
                    'kansas_city': ['kansas city', 'kansas city mo', 'kansas city missouri', 'kc zoning', 'kansas city code'],
                    'dallas': ['dallas', 'dallas tx', 'dallas texas', 'dallas zoning', 'dallas code'],
                    'new_york': ['new york', 'nyc', 'new york city', 'nyc zoning', 'new york code'],
                    'los_angeles': ['los angeles', 'la', 'l.a.', 'los angeles zoning', 'la code'],
                    'chicago': ['chicago', 'chicago il', 'chicago illinois', 'chicago zoning', 'chicago code']
                };
                this.cachedDocuments = new Map();
                this.documentIndex = new Map();
                this.semanticIndex = new Map();
                this.documentMetadata = new Map();
                this.searchHistory = new Map();
                this.maxCacheSize = 1000;
            }

            async initialize() {
                console.log('üöÄ Initializing Google Drive Service...');
                // Simulate initialization delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                console.log('‚úÖ Google Drive Service initialized');
            }

            async loadTownSpecificDocuments(townCode) {
                try {
                    console.log(`üîç Loading documents for town: ${townCode}`);
                    
                    // Check cache first
                    if (this.cachedDocuments.has(townCode)) {
                        console.log(`üìã Using cached documents for ${townCode}`);
                        return this.cachedDocuments.get(townCode);
                    }

                    // Get all documents from Google Drive
                    const allDocuments = await this.loadFolderDocuments();
                    
                    // Filter documents by town with enhanced matching
                    const townDocuments = this.filterDocumentsByTown(allDocuments, townCode);
                    
                    // Cache the results
                    if (this.cachedDocuments.size >= this.maxCacheSize) {
                        this.clearOldestCache();
                    }
                    this.cachedDocuments.set(townCode, townDocuments);
                    
                    console.log(`‚úÖ Found ${townDocuments.length} documents for ${townCode}`);
                    return townDocuments;
                } catch (error) {
                    console.error('Error loading town-specific documents:', error);
                    throw error;
                }
            }

            filterDocumentsByTown(documents, townCode) {
                const townKeywords = this.townDocumentMapping[townCode] || [];
                
                return documents.filter(doc => {
                    const title = doc.title.toLowerCase();
                    const content = (doc.content_text || '').toLowerCase();
                    const tags = (doc.tags || []).map(tag => tag.toLowerCase());
                    
                    const titleMatch = townKeywords.some(keyword => title.includes(keyword));
                    const contentMatch = townKeywords.some(keyword => content.includes(keyword));
                    const tagMatch = townKeywords.some(keyword => tags.some(tag => tag.includes(keyword)));
                    
                    const cityPatterns = {
                        'kansas_city': ['kc', 'kansas city', 'missouri', 'mo'],
                        'dallas': ['dallas', 'texas', 'tx', 'dfw'],
                        'new_york': ['nyc', 'new york', 'manhattan', 'brooklyn', 'queens'],
                        'los_angeles': ['la', 'los angeles', 'california', 'ca'],
                        'chicago': ['chicago', 'illinois', 'il', 'windy city']
                    };
                    
                    const cityPattern = cityPatterns[townCode];
                    const cityMatch = cityPattern ? cityPattern.some(pattern => 
                        title.includes(pattern) || content.includes(pattern)
                    ) : false;
                    
                    return titleMatch || contentMatch || tagMatch || cityMatch;
                });
            }

            async loadFolderDocuments() {
                try {
                    console.log('üìÅ Loading documents from Google Drive folder...');
                    
                    // Simulate API call delay
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Mock documents for demonstration
                    const mockDocuments = [];
                    
                    // Kansas City documents
                    for (let i = 1; i <= 15; i++) {
                        mockDocuments.push({
                            id: `kc_doc_${i}`,
                            title: `Kansas City Zoning Code ${i}`,
                            content_text: `Kansas City zoning regulations for district ${i}. Includes setback requirements, height limits, and permitted uses.`,
                            document_type: 'zoning_code',
                            source: 'google_drive',
                            tags: ['kansas city', 'zoning', 'regulations'],
                            upload_date: new Date(Date.now() - i * 86400000).toISOString()
                        });
                    }
                    
                    // Dallas documents
                    for (let i = 1; i <= 12; i++) {
                        mockDocuments.push({
                            id: `dallas_doc_${i}`,
                            title: `Dallas Development Standards ${i}`,
                            content_text: `Dallas development and zoning standards for area ${i}. Covers building codes, setbacks, and land use.`,
                            document_type: 'development_standards',
                            source: 'google_drive',
                            tags: ['dallas', 'development', 'zoning'],
                            upload_date: new Date(Date.now() - i * 86400000).toISOString()
                        });
                    }
                    
                    // General zoning documents
                    for (let i = 1; i <= 25; i++) {
                        mockDocuments.push({
                            id: `general_doc_${i}`,
                            title: `General Zoning Standards ${i}`,
                            content_text: `General zoning and building code information for various jurisdictions. Includes common practices and standards.`,
                            document_type: 'general_standards',
                            source: 'google_drive',
                            tags: ['general', 'zoning', 'standards'],
                            upload_date: new Date(Date.now() - i * 86400000).toISOString()
                        });
                    }
                    
                    console.log(`‚úÖ Loaded ${mockDocuments.length} documents from Google Drive`);
                    return mockDocuments;
                } catch (error) {
                    console.error('Error loading Google Drive documents:', error);
                    throw error;
                }
            }

            getDocumentStats() {
                const stats = {};
                for (const [townCode, documents] of this.cachedDocuments) {
                    stats[townCode] = documents.length;
                }
                return stats;
            }

            clearOldestCache() {
                const entries = Array.from(this.cachedDocuments.entries());
                if (entries.length > this.maxCacheSize * 0.8) {
                    const toRemove = entries.slice(0, Math.floor(entries.length * 0.2));
                    toRemove.forEach(([townCode]) => {
                        this.cachedDocuments.delete(townCode);
                    });
                    console.log(`üóëÔ∏è Cleared ${toRemove.length} oldest cache entries`);
                }
            }
        }

        // RAG Service Class (Embedded)
        class ZoningRAGService {
            constructor() {
                this.documentIndex = new Map();
                this.vectorStore = new Map();
                this.externalSources = new Map();
                this.initialized = false;
            }

            async initialize() {
                if (this.initialized) return;
                console.log('üß† Initializing RAG Service...');
                
                await this.initializeExternalSources();
                this.initialized = true;
                console.log('‚úÖ RAG Service initialized');
            }

            async initializeExternalSources() {
                try {
                    this.externalSources.set('zoning_info', {
                        name: 'Zoning Information Database',
                        description: 'Comprehensive zoning regulations and codes',
                        available: true
                    });
                    
                    this.externalSources.set('building_codes', {
                        name: 'Building Codes Database',
                        description: 'National and international building codes',
                        available: true
                    });
                    
                    this.externalSources.set('city_data', {
                        name: 'City Data Repository',
                        description: 'Municipal zoning and planning data',
                        available: true
                    });
                    
                    console.log('‚úÖ External sources initialized');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Some external sources may not be available:', error);
                }
            }

            async queryWithRAG(query, townDocuments, city) {
                try {
                    console.log(`üß† Processing RAG query: "${query}"`);
                    
                    // Simulate processing delay
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Generate response based on documents and external knowledge
                    const response = await this.generateComprehensiveResponse(query, townDocuments, city);
                    
                    return response;
                } catch (error) {
                    console.error('RAG query failed:', error);
                    throw error;
                }
            }

            async generateComprehensiveResponse(query, townDocuments, city) {
                try {
                    // Create comprehensive AI prompt
                    const systemPrompt = `You are a comprehensive zoning and building code expert. 
                    Answer questions based on both local documents and general knowledge from external sources.
                    Be specific and cite sources when possible.`;

                    const userPrompt = `Question: ${query}\n\nCity: ${city}\n\nAvailable Documents: ${townDocuments.length} local documents\n\nPlease provide a comprehensive answer that combines local document information with general zoning knowledge.`;

                    // Generate response
                    const response = await this.invokeAIAgent(systemPrompt, userPrompt);
                    
                    // Calculate confidence
                    const confidence = this.calculateResponseConfidence(townDocuments.length);
                    
                    return {
                        answer: response,
                        sources: [
                            { name: 'Google Drive Documents', type: 'local', relevance: 0.9 },
                            { name: 'External Zoning Database', type: 'external', relevance: 0.8 },
                            { name: 'Building Codes Repository', type: 'external', relevance: 0.7 }
                        ],
                        confidence
                    };
                } catch (error) {
                    console.error('Error generating comprehensive response:', error);
                    return {
                        answer: 'Unable to generate comprehensive response at this time',
                        sources: [],
                        confidence: 0
                    };
                }
            }

            calculateResponseConfidence(documentCount) {
                let confidence = 0.5; // Base confidence
                
                if (documentCount > 0) {
                    confidence += Math.min(0.3, documentCount * 0.02); // Bonus for documents
                }
                
                confidence += 0.2; // Bonus for external sources
                
                return Math.min(0.95, confidence);
            }

            async invokeAIAgent(systemPrompt, userPrompt) {
                try {
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    let response = '';
                    const queryLower = userPrompt.toLowerCase();
                    
                    if (queryLower.includes('kansas city')) {
                        response = `Based on the Kansas City zoning documents in your Google Drive, the city uses a comprehensive zoning code with districts including R-1 (Single Family Residential), R-2 (Two Family), R-3 (Multi-Family), C-1 (Commercial), and I-1 (Industrial). The zoning code follows standard Missouri practices with specific provisions for mixed-use development and transit-oriented design. Building height limits are typically 35 feet maximum in residential zones, with lot coverage maximum of 25% in residential areas.`;
                    } else if (queryLower.includes('dallas')) {
                        response = `According to Dallas zoning documents in your Google Drive, the city uses zoning districts including R-1 through R-3 for residential, CA for Central Area, CS for Commercial Services, and MF for Multi-Family. Dallas has specific overlay districts for historic preservation and development standards. Height limits vary by district, with residential zones typically limited to 35 feet and commercial zones allowing up to 240 feet in some areas.`;
                    } else if (queryLower.includes('setback')) {
                        response = `Setback requirements vary by zone and city. In residential zones, typical setbacks are: Front 25ft, Rear 20ft, Side 15ft minimum. Commercial zones may have different requirements based on the specific district and building height. These setbacks ensure proper spacing between buildings and provide access for utilities and maintenance.`;
                    } else if (queryLower.includes('zoning code')) {
                        response = `Zoning codes are municipal regulations that control land use and development. They typically include district classifications, permitted uses, building standards, setback requirements, height limits, and lot coverage restrictions. Each city has its own specific zoning code that reflects local planning priorities and development goals.`;
                    } else if (queryLower.includes('medical office') || queryLower.includes('commercial')) {
                        response = `Medical offices are typically allowed in commercial zones (C-1, C-2) and some mixed-use districts. However, specific requirements vary by city and zone. You'll need to check the local zoning code for exact permitted uses, parking requirements, and any special conditions that may apply to medical facilities.`;
                    } else {
                        response = `Based on the available zoning documents in your Google Drive and general knowledge, I can provide information about zoning regulations, building codes, and development standards. The specific requirements vary by jurisdiction and zone classification. For detailed information about a specific city or topic, please ask a more specific question.`;
                    }
                    
                    return response;
                } catch (error) {
                    console.error('AI Agent error:', error);
                    return 'I apologize, but I encountered an error processing your request. Please try again.';
                }
            }
        }
    </script>
</body>
</html>
